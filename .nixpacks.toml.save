app.get('/search', async (req, res) => {
  const keyword = req.query.keyword;
  if (!keyword) return res.status(400).send('請提供 keyword');

  const url = `https://www.sex100.co/search/?keyword=${encodeURIComponent(keyword)}`;

  try {
    const browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-zygote',
        '--disable-gpu',
        '--single-process'
      ]
    });
    const page = await browser.newPage();
    await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });

    const content = await page.content();
    await browser.close();

    res.send(content);
  } catch (err) {
    console.error('❌ Puppeteer error:', err);
    res.status(500).send('❌ 爬蟲失敗，請查看 Railway logs');
  }
});

app.get('/', (req, res) => {
  res.send('✅ Puppeteer API is running on Railway');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`✅ Server running at http://localhost:${PORT}`);
});
01:41 二廚（八個浪/高雄愛瑪仕 對帳） {
  "build": {
    "env": {
      "PUPPETEER_SKIP_DOWNLOAD": "true"
    }
  }
}
01:42 小沫 {
  "name": "puppeteer-api",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "^4.21.2",
    "puppeteer": "^21.11.0"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
01:43 小沫 FROM node:18-slim

# 安裝系統套件以支援 Puppeteer 運行
RUN apt-get update && apt-get install -y \
    wget \
    ca-certificates \
    fonts-liberation \
    libappindicator3-1 \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libcups2 \
    libdbus-1-3 \
    libgdk-pixbuf2.0-0 \
    libnspr4 \
    libnss3 \
    libx11-xcb1 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    xdg-utils \
    --no-install-recommends \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000
CMD ["npm", "start"]
01:45 小沫 git add .
git commit -m "chore: add Dockerfile & engine for Railway puppeteer"
git push origin main
01:48 小沫 // index.js
const express = require('express');
const puppeteer = require('puppeteer');

const app = express();

app.get('/search', async (req, res) => {
  const keyword = req.query.keyword;
  if (!keyword) return res.status(400).send('請提供 keyword');

  const url = `https://www.sex100.co/search/?keyword=${encodeURIComponent(
    keyword
  )}`;

  let browser;
  try {
    browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-zygote',
        '--disable-gpu',
        '--single-process'
      ]
    });

    const page = await browser.newPage();
    await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });

    // 等到真正列表元素出現再回傳，避免只拿到 loading 畫面
    await page.waitForSelector('.index_menu_row', { timeout: 30000 });

    const content = await page.content();
    res.send(content);
  } catch (err) {
    console.error('❌ Puppeteer error:', err);
    res.status(500).send('❌ 爬蟲失敗，請查看 Railway logs');
  } finally {
    if (browser) await browser.close().catch(() => {});
  }
});

app.get('/', (req, res) => {
  res.send('✅ Puppeteer API is running on Railway');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`✅ Server running at http://localhost:${PORT}`);
});
01:48 小沫 {
  "name": "puppeteer-api",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "^4.21.2",
    "puppeteer": "^21.11.0"
  }
}
01:48 小沫 # Dockerfile
FROM node:20-slim

# 安裝 Puppeteer 需要的系統套件
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        fonts-noto-color-emoji \
        && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY package*.json ./
RUN npm ci --omit=dev

COPY . .

ENV PORT=3000 \
    PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true

# Railway 會自動注入 process.env.PORT
EXPOSE 3000
CMD ["npm", "start"]
01:49 小沫 git add .
git commit -m "feat: add puppeteer crawler with waitForSelector & finally"
git push origin main   # 或你的主要分支
01:50 小沫 https://<your-domain>.up.railway.app/
01:50 小沫 https://<your-domain>.up.railway.app/search?keyword=口香糖
01:51 二廚（八個浪/高雄愛瑪仕 對帳） https://puppeteer-api-production-0444.up.railway.app/
01:51 二廚（八個浪/高雄愛瑪仕 對帳） https://puppeteer-api-production-0444.up.railway.app/search?keyword=口香糖
01:59 小沫 const express = require('express');
const puppeteer = require('puppeteer');

const app = express();

app.get('/search', async (req, res) => {
  const keyword = req.query.keyword;
  if (!keyword) return res.status(400).send('請提供 keyword');

  const url = `https://www.sex100.co/search/?keyword=${encodeURIComponent(keyword)}`;

  try {
    const browser = await puppeteer.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-zygote',
        '--disable-gpu',
        '--single-process'
      ]
    });

    const page = await browser.newPage();

    // 繞過年齡遮罩或 JS 阻擋：設定 User-Agent 和 Headers
    await page.setUserAgent(
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'
    );

    await page.setExtraHTTPHeaders({
      'Accept-Language': 'zh-TW,zh;q=0.9'
    });

    await page.goto(url, { waitUntil: 'networkidle2', timeout: 60000 });

    // 直接擷取 HTML 原始碼回傳
    const content = await page.content();
    await browser.close();

    res.status(200).send(content);
  } catch (err) {
    console.error('❌ Puppeteer error:', err);
    res.status(500).send('❌ 爬蟲失敗，請查看 Railway logs');
  }
});

app.get('/', (req, res) => {
  res.send('✅ Puppeteer API is running on Railway');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`✅ Server running at http://localhost:${PORT}`);
});
02:00 小沫 {
  "name": "puppeteer-api",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "^4.21.2",
    "puppeteer": "^21.11.0"
  }
}
02:30 二廚（八個浪/高雄愛瑪仕 對帳） You reached the start of the range → Jul 13, 2025 at 2:01 AM

 

[Region: asia-southeast1]

==============

Using Nixpacks

==============


context: jg1s-HxP2

╔══════════════════════════════ Nixpacks v1.38.0 ══════════════════════════════╗

║ setup      │ nodejs_18, npm-9_x, libnss3, libatk1.0-0, libatk-bridge2.0-0,   ║

║            │ libcups2, libgbm1, libasound2t64, libpangocairo-1.0-0, libxss1, ║

║            │ libgtk-3-0, libxshmfence1, libglu1, chromium                    ║

║──────────────────────────────────────────────────────────────────────────────║

║ install    │ npm ci                                                          ║

║──────────────────────────────────────────────────────────────────────────────║

║ start      │ npm run start                                                   ║

╚══════════════════════════════════════════════════════════════════════════════╝

[internal] load build definition from Dockerfile

[internal] load build definition from Dockerfile  ✔ 0毫秒

[internal] load build definition from Dockerfile

[internal] load build definition from Dockerfile  ✔ 11毫秒

[internal] load metadata for ghcr.io/railwayapp/nixpacks:ubuntu-1745885067

[internal] load metadata for ghcr.io/railwayapp/nixpacks:ubuntu-1745885067  ✔ 732毫秒

[internal] load .dockerignore

[internal] load .dockerignore  ✔ 0毫秒

[internal] load .dockerignore

[internal] load .dockerignore  ✔ 14毫秒

[internal] load build context  ✔ 0毫秒

[internal] load build context

[internal] load build context  ✔ 444毫秒

[stage-0 4/8] RUN nix-env -if .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix && nix-collect-garbage -d  ✔ 0毫秒 – CACHED

[stage-0 2/8] WORKDIR /app/  ✔ 0毫秒 – CACHED

[stage-0 3/9] COPY .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix  ✔ 0毫秒 – CACHED

[stage-0 4/9] RUN nix-env -if .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix && nix-collect-garbage -d  ✔ 0毫秒 – CACHED

[stage-0 5/9] RUN sudo apt-get update && sudo apt-get install -y --no-install-recommends libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libgbm1 libasound2t64 libpangocairo-1.0-0 libxss1 libgtk-3-0 libxshmfence1 libglu1 chromium  ✔ 0毫秒 – CACHED

[stage-0 6/9] COPY . /app/.

[stage-0 6/9] COPY . /app/.  ✔ 792毫秒

[stage-0 7/9] RUN --mount=type=cache,id=s/d7742383-1fc2-4a8d-99b9-edf59ed59090-/root/npm,target=/root/.npm npm ci

npm warn config production Use `--omit=dev` instead.

npm warn deprecated puppeteer@21.11.0: < 22.8.2 is no longer supported

 

Build timed out


puppeteer-api | Railway
02:35 小沫 const puppeteer = require('puppeteer');

const app = require('express')();

app.get('/search', async (req, res) => {
  const keyword = req.query.keyword;
  if (!keyword) return res.status(400).send('請提供 keyword');

  try {
    const browser = await puppeteer.launch({
      executablePath: '/usr/bin/chromium-browser',
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();
    await page.goto(`https://www.sex100.co/search/?keyword=${encodeURIComponent(keyword)}`, {
      waitUntil: 'networkidle2'
    });

    const content = await page.content();
    await browser.close();

    res.send(content);
  } catch (e) {
    console.error(e);
    res.status(500).send('Puppeteer 錯誤');
  }
});

app.listen(process.env.PORT || 3000, () => {
  console.log('✅ API Ready');
});
02:38 小沫 [phases.setup]
nixPkgs = [
  "chromium",
  "libnss3",
  "libatk1.0-0",
  "libatk-bridge2.0-0",
  "libcups2",
  "libgbm1",
  "libasound2",
  "libpangocairo-1.0-0",
  "libxss1",
  "libgtk-3-0",
  "libxshmfence1",
  "libglu1"
]
02:38 小沫 git add .nixpacks.toml
git commit -m "add nixpacks config for puppeteer dependencies"
git push
02:43 小沫 git add .nixpacks.toml
git commit -m "add nixpacks config for puppeteer on Railway"
git push
02:44 小沫 nano .nixpacks.toml
02:47 小沫 git push --set-upstream origin main
03:20 小沫 const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`✅ Server running at http://0.0.0.0:${PORT}`);
});
03:21 小沫 const puppeteer = require('puppeteer');

const app = require('express')();

app.get('/search', async (req, res) => {
  const keyword = req.query.keyword;
  if (!keyword) return res.status(400).send('請提供 keyword');

  try {
    const browser = await puppeteer.launch({
      executablePath: '/usr/bin/chromium-browser',
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();
    await page.goto(`https://www.sex100.co/search/?keyword=${encodeURIComponent(keyword)}`, {
      waitUntil: 'networkidle2'
    });

    const content = await page.content();
    await browser.close();

    res.send(content);
  } catch (e) {
    console.error(e);
    res.status(500).send('Puppeteer 錯誤');
  }
});

app.listen(process.env.PORT || 3000, () => {
  console.log('✅ API Ready');
});
03:23 二廚（八個浪/高雄愛瑪仕 對帳） const puppeteer = require('puppeteer');

const app = require('express')();

app.get('/search', async (req, res) => {
  const keyword = req.query.keyword;
  if (!keyword) return res.status(400).send('請提供 keyword');

  try {
    const browser = await puppeteer.launch({
      executablePath: '/usr/bin/chromium-browser',
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();
    await page.goto(`https://www.sex100.co/search/?keyword=${encodeURIComponent(keyword)}`, {
      waitUntil: 'networkidle2'
    });

    const content = await page.content();
    await browser.close();

    res.send(content);
  } catch (e) {
    console.error(e);
    res.status(500).send('Puppeteer 錯誤');
  }
});

app.listen(const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`✅ Server running at http://0.0.0.0:${PORT}`);
}););
03:24 小沫 const puppeteer = require('puppeteer');
const express = require('express');
const app = express();

app.get('/search', async (req, res) => {
  const keyword = req.query.keyword;
  if (!keyword) return res.status(400).send('請提供 keyword');

  try {
    const browser = await puppeteer.launch({
      executablePath: '/usr/bin/chromium-browser',
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();
    await page.goto(`https://www.sex100.co/search/?keyword=${encodeURIComponent(keyword)}`, {
      waitUntil: 'networkidle2'
    });

    const content = await page.content();
    await browser.close();

    res.send(content);
  } catch (e) {
    console.error('❌ Puppeteer 錯誤:', e);
    res.status(500).send('Puppeteer 錯誤');
  }
});

// 正確的 PORT 與監聽方式
const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`✅ Server running at http://0.0.0.0:${PORT}`);
});
03:24 小沫 git add index.js
git commit -m "fix: correct syntax and bind to 0.0.0.0"
git push
03:42 二廚（八個浪/高雄愛瑪仕 對帳） 
[Region: asia-southeast1]

==============

Using Nixpacks

==============


context: 5wg2-vnNR

╔══════════════════════════════ Nixpacks v1.38.0 ══════════════════════════════╗

║ setup      │ nodejs_18, npm-9_x, libnss3, libatk1.0-0, libatk-bridge2.0-0,   ║

║            │ libcups2, libgbm1, libasound2t64, libpangocairo-1.0-0, libxss1, ║

║            │ libgtk-3-0, libxshmfence1, libglu1, chromium                    ║

║──────────────────────────────────────────────────────────────────────────────║

║ install    │ npm ci                                                          ║

║──────────────────────────────────────────────────────────────────────────────║

║ start      │ npm run start                                                   ║

╚══════════════════════════════════════════════════════════════════════════════╝

[internal] load build definition from Dockerfile

[internal] load build definition from Dockerfile  ✔ 0毫秒

[internal] load build definition from Dockerfile

[internal] load build definition from Dockerfile  ✔ 9毫秒

[internal] load metadata for ghcr.io/railwayapp/nixpacks:ubuntu-1745885067

[internal] load metadata for ghcr.io/railwayapp/nixpacks:ubuntu-1745885067  ✔ 265毫秒

[internal] load .dockerignore

[internal] load .dockerignore  ✔ 0毫秒

[internal] load .dockerignore

[internal] load .dockerignore  ✔ 8毫秒

[stage-0 9/9] COPY . /app

[stage-0 8/9] RUN printf '\nPATH=/app/node_modules/.bin:$PATH' >> /root/.profile

[stage-0 7/9] RUN --mount=type=cache,id=s/d7742383-1fc2-4a8d-99b9-edf59ed59090-/root/npm,target=/root/.npm npm ci

[stage-0 6/9] COPY . /app/.

[stage-0 5/9] RUN sudo apt-get update && sudo apt-get install -y --no-install-recommends libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libgbm1 libasound2t64 libpangocairo-1.0-0 libxss1 libgtk-3-0 libxshmfence1 libglu1 chromium

[stage-0 4/9] RUN nix-env -if .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix && nix-collect-garbage -d

[stage-0 3/9] COPY .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix

[internal] load build context

[stage-0 2/9] WORKDIR /app/

[stage-0 1/9] FROM ghcr.io/railwayapp/nixpacks:ubuntu-1745885067@sha256:d45c89d80e13d7ad0fd555b5130f22a866d9dd10e861f589932303ef2314c7de

[internal] load build context

[stage-0 1/9] FROM ghcr.io/railwayapp/nixpacks:ubuntu-1745885067@sha256:d45c89d80e13d7ad0fd555b5130f22a866d9dd10e861f589932303ef2314c7de

[internal] load build context  ✔ 0毫秒

[phases.setup]
nixPkgs = [
  "nodejs_18",
  "libnss3",
  "libatk1.0-0",
  "libatk-bridge2.0-0",
  "libcups2",
  "libgbm1",
  "libasound2",
  "libpangocairo-1.0-0",
  "libxss1",
  "libgtk-3-0",
  "libxshmfence1",
  "libglu1",
  "chromium"
]
